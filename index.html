<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPS Store Tag Tool</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bwip-js/3.0.4/bwip-js-min.js"></script>

    <style>
        /* --- CSS STYLING --- */
        * { box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 0; 
            background: #e9ecef; 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
        }
        
        .main-content { display: flex; flex: 1; width: 100%; height: 100%; }
        
        /* Left Panel */
        .controls-panel { 
            width: 350px; 
            padding: 30px; 
            background: white; 
            border-right: 1px solid #ccc; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            z-index: 10; 
            justify-content: center; 
        }
        
        /* Right Panel */
        .preview-panel { 
            flex: 1; 
            background: #525659; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            overflow-y: auto; 
        }
        
        iframe { 
            width: 400px; 
            height: 600px; 
            border: none; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            background: white; 
        }

        /* Inputs */
        .input-group { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        
        .field { display: flex; flex-direction: column; gap: 6px; }
        
        label { 
            font-weight: 700; 
            font-size: 0.8em; 
            color: #555; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        
        input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 16px; 
            transition: border 0.2s, box-shadow 0.2s; 
        }
        
        input:focus { 
            outline: none; 
            border-color: #007bff; 
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1); 
        }
        
        /* Buttons */
        .btn-col { display: flex; flex-direction: column; gap: 15px; }
        
        button { 
            padding: 16px; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 16px; 
            transition: transform 0.1s, background 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
        }
        
        button:active { transform: scale(0.98); }
        
        .btn-dl { background: #28a745; color: white; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2); } 
        .btn-dl:hover { background: #218838; }
        
        .btn-clear { background: white; color: #dc3545; border: 2px solid #f8f9fa; } 
        .btn-clear:hover { background: #fff5f5; border-color: #dc3545; }

        #genCanvas { display: none; }
    </style>
</head>
<body>

<div class="main-content">
    
    <div class="controls-panel">
        
        <div class="input-group">
            <div class="field">
                <label>Item Name</label>
                <input type="text" id="itemName" placeholder="e.g. Bubble Wrap" autocomplete="off" />
            </div>
            
            <div class="field">
                <label>Price ($)</label>
                <input type="text" id="itemPrice" placeholder="e.g. 1,000.00" maxlength="10" autocomplete="off" 
                       onblur="formatPriceInput(this)" />
            </div>

            <div class="field">
                <label>SKU (8 Digits Max)</label>
                <input type="text" id="itemSku" placeholder="e.g. 10020030" maxlength="8" autocomplete="off" />
            </div>
        </div>

        <div class="btn-col">
            <button class="btn-dl" onclick="downloadPDF()">ðŸ“¥ Download PDF</button>
            <button class="btn-clear" onclick="clearFields()">âœ¨ Clear Fields</button>
        </div>
    </div>

    <div class="preview-panel">
        <iframe id="pdfPreview" title="PDF Preview"></iframe>
    </div>

</div>

<canvas id="genCanvas"></canvas>

<script>
    const canvas = document.getElementById('genCanvas');
    let debounceTimer;

    // --- 1. EVENT LISTENERS ---
    
    document.getElementById('itemName').addEventListener('input', () => triggerPreview());

    document.getElementById('itemSku').addEventListener('input', function() {
        let val = this.value.replace(/[^0-9]/g, '');
        if (val.length > 8) val = val.substring(0, 8);
        this.value = val;
        triggerPreview();
    });

    document.getElementById('itemPrice').addEventListener('input', function() {
        // Remove non-numeric chars (except dot)
        let raw = this.value.replace(/[^0-9.]/g, '');
        
        // Prevent double dots
        const parts = raw.split('.');
        if (parts.length > 2) {
            raw = parts[0] + '.' + parts.slice(1).join('');
        }
        
        // --- LIMIT LOGIC (Max 99,999.99) ---
        // 1. Limit Integer part to 5 digits
        if (parts[0].length > 5) {
            parts[0] = parts[0].substring(0, 5);
            if (parts.length > 1) raw = parts[0] + "." + parts[1];
            else raw = parts[0];
        }

        // 2. Limit Decimal part to 2 digits
        if (parts.length > 1 && parts[1].length > 2) {
            parts[1] = parts[1].substring(0, 2);
            raw = parts[0] + "." + parts[1];
        }

        this.value = raw;
        triggerPreview();
    });

    // Format Price on Blur (Adds Commas + .00)
    function formatPriceInput(input) {
        if (!input.value) return;
        
        const cleanVal = input.value.replace(/,/g, '');
        const num = parseFloat(cleanVal);
        
        if (!isNaN(num)) {
            // Format with commas and 2 decimals
            const formatted = num.toLocaleString('en-US', {
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
            input.value = formatted;
            updatePreview();
        }
    }

    function triggerPreview() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updatePreview, 300);
    }

    // --- 2. BARCODE GENERATOR (DATA MATRIX) ---
    function generateBarcodeData(sku) {
        if (!sku) return null;
        try {
            bwipjs.toCanvas(canvas, {
                bcid: 'datamatrix', 
                text: sku, 
                scale: 2, 
                height: 10, 
                includetext: false, 
                padding: 0
            });
            return canvas.toDataURL('image/png');
        } catch (e) {
            return null;
        }
    }

    // --- 3. CLEAR FIELDS ---
    function clearFields() {
        document.getElementById('itemName').value = '';
        document.getElementById('itemPrice').value = '';
        document.getElementById('itemSku').value = '';
        document.getElementById('itemName').focus();
        document.getElementById('pdfPreview').src = "about:blank";
    }

    // --- 4. PDF ENGINE (Fixed 15 Tags) ---
    function createFullSheetPDF() {
        const name = document.getElementById('itemName').value.trim();
        let rawPrice = document.getElementById('itemPrice').value.trim();
        const sku = document.getElementById('itemSku').value.trim();

        if (!name && !rawPrice && !sku) return null;

        let displayPrice = rawPrice;
        
        // Display price with commas
        const cleanVal = rawPrice.replace(/,/g, '');
        const numPrice = parseFloat(cleanVal);
        if (!isNaN(numPrice)) {
            displayPrice = numPrice.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        const imgData = generateBarcodeData(sku);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "p", unit: "in", format: [4, 6] });

        // --- MARGIN LOGIC ---
        // Top: Small (0.05")
        // Bottom: Large (0.75") for disclaimer
        // Sides: 0.04"
        const MARGIN_TOP = 0.05;
        const MARGIN_BOTTOM = 0.75; 
        const MARGIN_SIDE = 0.04;

        const cols = 3;
        const rows = 5;
        
        const printableWidth = 4 - (MARGIN_SIDE * 2);
        const printableHeight = 6 - (MARGIN_TOP + MARGIN_BOTTOM);
        
        const tagWidth = printableWidth / cols;
        const tagHeight = printableHeight / rows;

        let col = 0;
        let row = 0;
        const TOTAL_TAGS = 15;

        for (let i = 0; i < TOTAL_TAGS; i++) {
            const x = MARGIN_SIDE + (col * tagWidth);
            const y = MARGIN_TOP + (row * tagHeight);
            const centerX = x + (tagWidth/2);
            
            // 1. Draw Border (Black)
            doc.setLineWidth(0.01);
            doc.setDrawColor(0); 
            doc.rect(x, y, tagWidth, tagHeight);

            // 2. Draw Name
            let displayName = name.length > 18 ? name.substring(0,17) + ".." : name;
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            doc.text(displayName, centerX, y + 0.16, { align: "center" });

            // 3. Draw Barcode (Data Matrix)
            if (imgData) {
                doc.addImage(imgData, 'PNG', centerX - 0.225, y + 0.22, 0.45, 0.40);
            }

            // 4. Draw SKU Text
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            doc.text(sku, centerX, y + 0.70, { align: "center" });

            // 5. Draw Price (With Commas)
            if (displayPrice) {
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text(`$${displayPrice}`, centerX, y + tagHeight - 0.10, { align: "center" });
            }

            // Grid Increment
            col++;
            if (col >= cols) { col = 0; row++; }
        }
        
        return doc;
    }

    // --- 5. PREVIEW & DOWNLOAD ---
    function updatePreview() {
        const doc = createFullSheetPDF();
        if (doc) {
            const pdfBlob = doc.output('bloburl');
            document.getElementById('pdfPreview').src = pdfBlob;
        } else {
            document.getElementById('pdfPreview').src = "about:blank";
        }
    }

    function downloadPDF() {
        const doc = createFullSheetPDF();
        if (doc) {
            // Filename Logic: SKU-Price.pdf (No commas in filename)
            let filename = "Tags.pdf";
            
            const sku = document.getElementById('itemSku').value.trim();
            const rawPrice = document.getElementById('itemPrice').value.trim();
            
            // Format price for filename (standard format, NO commas)
            let priceStr = "";
            const cleanVal = rawPrice.replace(/,/g, '');
            const numPrice = parseFloat(cleanVal);
            if (!isNaN(numPrice)) {
                priceStr = numPrice.toFixed(2);
            }

            if (sku && priceStr) {
                filename = `${sku}-${priceStr}.pdf`;
            }
            
            doc.save(filename);
        } else {
            alert("Please enter item details first.");
        }
    }
</script>

</body>
</html>
